# 단위 테스트란 무엇인가

## 용어

- `SUT` : 테스트 대상 시스템(System Under Test), 클래스 전체
- `MUT` : 테스트 대상 메서드(Method Under Test)

## `단위 테스트`의 정의

- 작은 코드 조각(단위)을 검증하고,
- 빠르게 수행하고,
- 격리된 방식으로 처리하는 자동화된 테스트

## 격리 문제에 대한 `런던파`의 접근

- 테스트 대상 시스템을 협력자(collaborator)`에게서 격리하는 것
- 하나의 클래스가 다른 클래스에 의존하면 모든 의존성을 테스트 대역(test double)으로 대체해야 한다.
  - 동작을 외부 영향과 분리해서 테스트 대상 클래스에만 집중할 수 있다.
- 테스트가 실패하면 코드베이스의 어느 부분이 고장 났는지 확실히 알 수 있다.
  - 모든 의존성은 테스트 대역으로 대체됐기 때문에 의심할 여지가 없다.
- 객체 그래프(object graph, 같은 문제를 해결하는 클래스의 통신망)를 분할할 수 있다.
- 테스트 대상 클래스를 의존성에서 분리하면 단순한 테스트 스위트 구조(프로덕션 코드의 각 클래스에 대해 테스트 클래스가 하나씩 있는 구조)를 확립하는 데 도움이 된다.

## 격리 문제에 대한 `고전파`의 접근

- 코드를 꼭 격리하는 방식으로 테스트해야 하는 것은 아니다.
  - 대신 단위 테스트는 서로 격리해서 실행해야 한다.
- 테스트 대역을 사용할 수 있지만, 보통 테스트 간에 공유 상태를 일으키는 의존성에 대해서만 사용한다.
- 공유 의존성은 테스트 대상 클래스 간이 아니라 단위 테스트 간에 공유한다.
  - 싱글턴 의존성은 각 인스턴스에서 새 인스턴스를 만들 수 있기만 하면 공유되지 않는다. ➡️ 라면, 이 의존성은 비공개인 것
  - 대체하는 이유 : 테스트 실행 속도를 높인다.
- 단위가 반드시 클래스에 국한될 필요는 없다. 공유 의존성이 없는 한 여러 클래스를 묶어서 단위 테스트할 수도 있다.

---

### 공유 의존성(shared dependency)

- 테스트 간에 공유되고 서로의 결과에 영향을 미칠 수 있는 수단을 제공하는 의존성
- 정적 가변 필드(static mutable field)
- 데이터베이스

### 비공개 의존성(private dependency)

- 공유하지 않는 의존성

### 프로세스 외부 의존성(out-of-process dependency)

- 애플리케이션 실행 프로세스 외부에서 실행되는 의존성
- 아직 메모리에 없는 데이터에 대한 프록시
- 데이터베이스 : 프로세스 외부이면서 공유 의존성
  - 테스트 실행 전 도커 컨테이너로 데이터베이스를 시작하면 테스트가 더 이상 동일한 인스턴스로 작동하지 않음 ➡️ 프로세스 외부이면서 공유하지 않는 의존성이 됨

### 휘발성 의존성(volatile dependency)

- 개발자 머신에 기본 설치된 환경 외에 런타임 환경의 설정 및 구성을 요구한다.
  - 데이터베이스, API
  - 추가 설정이 필요하며 시스템에 기본적으로 설치돼 있지 않다.
- 비결정적 동작(nondeterministic behacior)을 포함한다
  - 난수 생성기, 현재 날짜와 시간을 반환하는 클래스 등
  - 각 호출에 대해 다른 결과를 제공함
- 데이터베이스 : 공유 의존성 & 휘발성 의존성
- 파일 시스템 : 휘발성 ❌, 공유 의존성
- 난수 생성기 : 휘발성, 각 테스트에 별도의 인스턴스 제공 가능 ➡️ 공유 의존성 ❌

### 협력자(collaborator)

- 공유하거나 변경 가능한 의존성
- 데이터베이스 : 공유 의존성
  - 데이터 베이스 접근 권한을 제공하는 클래스 : 협력자

---

|        | 격리 주체   | 단위의 크기                  | 테스트 대역 사용 대상      |
| ------ | ----------- | ---------------------------- | -------------------------- |
| 런던파 | 단위        | 단일 클래스                  | 불변 의존성 외 모든 의존성 |
| 고전파 | 단위 테스트 | 단일 클래스 또는 클래스 세트 | 공유 의존성                |

## 런던파의 장점

- 입자성(granularity)이 좋다. 테스트가 세밀해서 한 번에 한 클래스만 확인한다.
- 서로 연결된 클래스의 그래프가 커져도 테스트하기 쉽다. 모든 협력자는 테스트 대역으로 대체되기 때문에 테스트 작성 시 걱정할 필요가 없다.
- 테스트가 실패하면 어떤 기능이 실패했는지 확실히 알 수 있다.

> 테스트는 코드의 단위를 검증해서는 안 된다.

- 동작의 단위, 문제 영역에 의미가 있는 것, 비즈니스 담당자가 유용하다고 인식할 수 있는 것을 검증해야 한다.

> 상호 연결된 클래스의 크고 복잡한 그래프를 테스트할 방법을 찾는 대신, 먼저 이러한 클래스 그래프를 갖지 않는 데 집중해야 한다.

- 클래스 그래프가 커진 것은 코드 설계 문제의 결과다.

## 고전파와 런던파 차이점

- 테스트 주도 개발을 통한 시스템 설계 방식
  - 고전파 : 일반적으로 상향식
  - 런던파 : 하향식 TDD, 전체 시스템에 대한 기대치를 설정하는 상위 레벨 테스트부터 시작한다.
- 과도한 명세 문제 : 테스트가 SUT의 구현 세부 사항에 결합된다.
